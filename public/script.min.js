document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("provinceSelect"),t=document.getElementById("wardSelect"),n=document.getElementById("searchForm"),a=document.getElementById("searchInput"),o=document.getElementById("result"),s=document.getElementById("selectedInfo"),d=document.getElementById("selectedProvince"),i=document.getElementById("selectedWard"),c=document.getElementById("selectedWardCode"),l=document.getElementById("suggestionList"),r=document.getElementById("clearBtn"),m=document.getElementById("themeToggle"),u=document.getElementById("themeIcon");let p=null;function v(e){"light"===e?(document.body.classList.add("light-mode"),u.classList.remove("fa-moon"),u.classList.add("fa-sun")):(document.body.classList.remove("light-mode"),u.classList.remove("fa-sun"),u.classList.add("fa-moon"))}function g(e=""){let t="/api/stats";e&&(t+=`?province_code=${e}`),fetch(t).then(e=>e.json()).then(e=>{document.getElementById("statProvinces").textContent=e.numProvinces,document.getElementById("statWards").textContent=e.numWards,document.getElementById("statCurrentWards").textContent=e.currentWards})}function h(e,t,n,a){e||t||n?(s.style.display="block",d.textContent=a&&e?a+" – "+e:e||"",i.textContent=t||"",c.textContent=n||""):s.style.display="none"}v("light"===localStorage.getItem("theme-mode")?"light":"dark"),m.addEventListener("click",function(){document.body.classList.toggle("light-mode")?(u.classList.remove("fa-moon"),u.classList.add("fa-sun"),localStorage.setItem("theme-mode","light")):(u.classList.remove("fa-sun"),u.classList.add("fa-moon"),localStorage.setItem("theme-mode","dark"))}),r.addEventListener("click",function(){e.value="",t.innerHTML='<option value="">-- Chọn Phường/Xã --</option>',a.value="",o.innerHTML="",h("","","",""),g(),l.style.display="none",r.style.display="none"}),fetch("/api/provinces").then(e=>e.json()).then(t=>{t.sort((e,t)=>e.name.localeCompare(t.name,"vi")),t.forEach(t=>{const n=document.createElement("option");n.value=t.province_code,n.textContent=t.name,e.appendChild(n)})}),g(),e.addEventListener("change",()=>{const n=e.value;if(t.innerHTML='<option value="">-- Chọn phường/xã --</option>',g(n),!n)return void h("","","","");h(e.options[e.selectedIndex].textContent,"","",n),fetch(`/api/wards?province_code=${n}`).then(e=>e.json()).then(e=>{e.sort((e,t)=>e.name.localeCompare(t.name,"vi")),e.forEach(e=>{const n=document.createElement("option");n.value=e.ward_code,n.textContent=e.name,t.appendChild(n)})})}),t.addEventListener("change",()=>{const n=e.options[e.selectedIndex],a=n?n.textContent:"",o=e.value||"",s=t.options[t.selectedIndex],d=s&&t.value?s.textContent:"",i=t.value||"";a||d||i?h(a,d,i,o):h("","","","")}),n.addEventListener("submit",e=>{e.preventDefault();const t=a.value.trim();t?fetch(`/api/search?q=${encodeURIComponent(t)}`).then(e=>e.json()).then(e=>{if(!e.length)return void(o.innerHTML='<div class="alert alert-danger">Không tìm thấy kết quả.</div>');let t='<ul class="list-group">';e.forEach((e,n)=>{"province"===e.type?t+=`<li class="list-group-item search-result-item" data-type="province" data-province-code="${e.province_code}" data-name="${e.name}">Tỉnh/Thành: <b>${e.name}</b></li>`:"ward"===e.type&&(t+=`<li class="list-group-item search-result-item" data-type="ward" data-province-code="${e.province_code}" data-ward-code="${e.ward_code}" data-name="${e.name}" data-province-name="${e.province_name}"><b>${e.name}</b><br><span style='font-size:0.97em;opacity:0.85;'>(Tỉnh/Thành: ${e.province_name})</span></li>`)}),t+="</ul>",o.innerHTML=t,Array.from(document.querySelectorAll(".search-result-item")).forEach(e=>{e.addEventListener("click",function(){const t=e.getAttribute("data-type");"province"===t?h(e.getAttribute("data-name"),"","",e.getAttribute("data-province-code")):"ward"===t&&h(e.getAttribute("data-province-name"),e.getAttribute("data-name"),e.getAttribute("data-ward-code"),e.getAttribute("data-province-code"))})})}):o.innerHTML='<div class="alert alert-warning">Vui lòng nhập từ khóa tìm kiếm.</div>'}),a.addEventListener("input",function n(){const o=a.value.trim();if(r.style.display=o?"flex":"none",p&&clearTimeout(p),!o)return l.style.display="none",void(l.innerHTML="");p=setTimeout(()=>{fetch(`/api/search?q=${encodeURIComponent(o)}`).then(e=>e.json()).then(o=>{if(!o.length)return l.style.display="none",void(l.innerHTML="");let s="";o.slice(0,20).forEach(e=>{"province"===e.type?s+=`<li class='suggestion-item' data-type='province' data-province-code='${e.province_code}'>\n                <div class='suggestion-main'>\n                  <span class='suggestion-title'>${e.name}</span>\n                </div>\n                <span class='suggestion-type-label province'>Tỉnh/TP</span>\n              </li>`:"ward"===e.type&&(s+=`<li class='suggestion-item' data-type='ward' data-province-code='${e.province_code}' data-ward-code='${e.ward_code}'>\n                <div class='suggestion-main'>\n                  <span class='suggestion-title'>${e.name}</span>\n                  <span class='suggestion-sub'>${e.province_name}</span>\n                </div>\n                <span class='suggestion-type-label ward'>Phường/Xã</span>\n              </li>`)}),l.innerHTML=s,l.style.display="block",Array.from(l.querySelectorAll(".suggestion-item")).forEach((o,s)=>{o.addEventListener("mousedown",function(s){s.preventDefault();const d=o.getAttribute("data-type"),i=o.getAttribute("data-province-code");if("province"===d)e.value=i,e.dispatchEvent(new Event("change")),l.style.display="none",a.value="",n();else if("ward"===d){const s=o.getAttribute("data-ward-code");e.value=i,e.dispatchEvent(new Event("change")),setTimeout(()=>{t.value=s,t.dispatchEvent(new Event("change"))},250),l.style.display="none",a.value="",n()}})})})},180)}),a.addEventListener("blur",function(){setTimeout(()=>{l.style.display="none"},120)})});